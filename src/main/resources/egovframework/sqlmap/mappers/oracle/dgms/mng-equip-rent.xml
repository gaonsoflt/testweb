<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.dgms.service.impl.MngEquipRentMapper">


    
    <select id="selectMngEquipInfoRent" parameterType="hashMap" resultType="hashMap">

	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT A.EQUIPMENT_SEQ
						      ,A.EQUIPMENT_ID
						      ,A.EQUIP_TYPE
						      ,CASE
						         WHEN A.EQUIP_STATE = '101069' AND
						              (SELECT COUNT(1)
						                 FROM TB_RENT_MNG
						                WHERE EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
						                  AND RENT_STATE = '101074') = 0 THEN
						          '대여가능'
						         ELSE
						          '대여중'
						       END AS RENT_YN --기기상태 정상 AND 대여중이 아닌것.
						      ,A.MODEL_NM
						      ,A.SERIAL_NO
						      ,A.EQUIP_STATE
						      ,A.EQUIPMENT_NM
						      ,A.PURCHASE_DT
						      ,A.AREA_ID
						      ,A.CRE_USR
						      ,A.CRE_DT
						      ,A.MOD_USR
						      ,A.MOD_DT
						  FROM TB_EQUIPMENT_INFO A
						  JOIN (SELECT A.EQUIPMENT_SEQ
						          FROM TB_EQUIPMENT_INFO A
						          LEFT JOIN TB_RENT_MNG B
						            ON B.EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
						         WHERE 1 = 1
						         <if test='USER_NM != null and USER_NM != ""'>
						           AND B.RENT_USER_NM LIKE '%'|| #{USER_NM} ||'%'
						         </if>
						         GROUP BY A.EQUIPMENT_SEQ) B
						    ON B.EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
	                     WHERE 1=1
	                     <if test='AREA_ID != null and AREA_ID != ""'>
	                       AND REPLACE(A.AREA_ID, 000000, '') LIKE REPLACE(#{AREA_ID}, 000000, '') || '%'
	                     </if>  
	                     <if test='EQUIP_TYPE != null and EQUIP_TYPE != ""'>
	                       AND A.EQUIP_TYPE = #{EQUIP_TYPE}
	                     </if>
	                     <if test='MODEL_NM != null and MODEL_NM != ""'>
	                       AND A.MODEL_NM = #{MODEL_NM}
	                     </if>
	                     <if test='EQUIP_STATE != null and EQUIP_STATE != ""'>
	                       AND A.EQUIP_STATE = #{EQUIP_STATE}
	                     </if>
	                     ORDER BY EQUIPMENT_ID
	                     ) A 
	                    
	           ) A
	     WHERE 1 = 1
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>

    </select>
    
    
    <select id="selectMngEquipInfoRentTot" parameterType="hashMap" resultType="int">

	    SELECT COUNT(*)
	      FROM TB_EQUIPMENT_INFO A
	      LEFT JOIN TB_RENT_MNG B
            ON B.EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
	     WHERE 1 = 1
        <if test='AREA_ID != null'>
          AND REPLACE(A.AREA_ID, 000000, '') LIKE REPLACE(#{AREA_ID}, 000000, '') || '%'
        </if>  
        <if test='EQUIP_TYPE != null'>
          AND A.EQUIP_TYPE = #{EQUIP_TYPE}
        </if>
        <if test='MODEL_NM != null'>
          AND A.MODEL_NM = #{MODEL_NM}
        </if>
        <if test='EQUIP_STATE != null'>
          AND A.EQUIP_STATE = #{EQUIP_STATE}
        </if>
        <if test='USER_NM != null and USER_NM != ""'>
          AND B.RENT_USER_NM LIKE '%'|| #{USER_NM} ||'%'
        </if>
    </select>
    
    
    <select id="selectMngEquipRentInfo" parameterType="hashMap" resultType="hashMap">

	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT A.RENT_SEQ
						      ,A.EQUIPMENT_SEQ
						      ,A.AREA_ID
						      ,A.USER_ID
						      ,A.RENT_STATE
						      ,A.RENT_DT
						      ,A.EXPIRE_DT
						      ,A.RENT_CNT
						      ,A.RENT_USER_NM
						      ,A.RENT_PLACE
						      ,A.RETURN_USER_NM
						      ,A.RETURN_DT
						      ,A.REMARK
						      ,A.CRE_USR
						      ,A.CRE_DT
						      ,A.MOD_USR
						      ,A.MOD_DT
						      ,C.EQUIPMENT_ID
						      ,C.MODEL_NM
						  FROM TB_RENT_MNG A
						  JOIN TB_EQUIPMENT_INFO C
						    ON C.EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
	                     WHERE 1=1
	                     <if test='EQUIPMENT_SEQ != null'>
	                       AND A.EQUIPMENT_SEQ = #{EQUIPMENT_SEQ}
	                     </if>
	                     <if test='USER_ID != null'>
				         	AND A.USER_ID = #{USER_ID}
				         </if>
				         <if test='RENT_STATE != null'>
				         	AND A.RENT_STATE = #{RENT_STATE}
				         </if>
				         <if test='MODEL_NM != null'>
				         	AND C.MODEL_NM = '%' || #{MODEL_NM} || '%'
				         </if>
				         <if test='AREA_ID != null'>
				         	AND REPLACE(A.AREA_ID, 0, '') LIKE REPLACE(#{AREA_ID}, 0, '') || '%'
				         </if> 
	                     ORDER BY A.RENT_SEQ
	                     ) A
	           ) A
	     WHERE 1 = 1
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>

    </select>
    
    
    <select id="selectMngEquipRentInfoTot" parameterType="hashMap" resultType="int">

	    SELECT COUNT(*)
	      FROM TB_RENT_MNG A
		  JOIN TB_EQUIPMENT_INFO C
		    ON C.EQUIPMENT_SEQ = A.EQUIPMENT_SEQ
	     WHERE 1 = 1
	    <if test='EQUIPMENT_SEQ != null'>
            AND A.EQUIPMENT_SEQ = #{EQUIPMENT_SEQ}
        </if>
        <if test='USER_ID != null'>
        	AND A.USER_ID = #{USER_ID}
        </if>
        <if test='RENT_STATE != null'>
        	AND A.RENT_STATE = #{RENT_STATE}
        </if>
        <if test='MODEL_NM != null'>
        	AND C.MODEL_NM = #{MODEL_NM}
        </if>
        <if test='AREA_ID != null'>
        	AND REPLACE(A.AREA_ID, 0, '') LIKE REPLACE(#{AREA_ID}, 0, '') || '%'
        </if>
    </select>
    
    
    
    <insert id="insertMngEquipRentInfo" >
	    INSERT INTO TB_RENT_MNG
	      (
			  RENT_SEQ
			  ,EQUIPMENT_SEQ
		      ,AREA_ID
		      ,USER_ID
		      ,RENT_STATE
		      ,RENT_DT
		      ,EXPIRE_DT
		      ,RENT_CNT
		      ,RENT_USER_NM
		      ,RENT_PLACE
		      ,RETURN_USER_NM
		      ,RETURN_DT
		      ,REMARK
		      ,CRE_USR
		      ,CRE_DT
		      ,MOD_USR
		      ,MOD_DT
	      )
	    VALUES
	      (
	      	#{RENT_SEQ     		,  jdbcType=VARCHAR},
	      	#{EQUIPMENT_SEQ     ,  jdbcType=VARCHAR},
			#{AREA_ID      		,  jdbcType=VARCHAR},
			#{USER_ID      	 	,  jdbcType=VARCHAR},
			#{RENT_STATE     	,  jdbcType=VARCHAR},
			#{RENT_DT       	,  jdbcType=VARCHAR},
			#{EXPIRE_DT     	,  jdbcType=VARCHAR},
			#{RENT_CNT          ,  jdbcType=VARCHAR},
			#{RENT_USER_NM      ,  jdbcType=VARCHAR},
			#{RENT_PLACE     	,  jdbcType=VARCHAR},
			#{RETURN_USER_NM    ,  jdbcType=VARCHAR},
			#{RETURN_DT			,  jdbcType=VARCHAR},
			#{REMARK			,  jdbcType=VARCHAR},
			#{CRE_USR       	,  jdbcType=VARCHAR},
			SYSDATE             ,
			#{MOD_USR       	,  jdbcType=VARCHAR},
			SYSDATE
	       ) 
		
	</insert>

	<update id="updateMngEquipRentInfo" >
	
    UPDATE TB_RENT_MNG
       SET  AREA_ID =
			#{AREA_ID      		,  jdbcType=VARCHAR},
			USER_ID =
			#{USER_ID      	 	,  jdbcType=VARCHAR},
			RENT_STATE =
			#{RENT_STATE     	,  jdbcType=VARCHAR},
			RENT_DT =
			#{RENT_DT       	,  jdbcType=VARCHAR},
			EXPIRE_DT =
			#{EXPIRE_DT     	,  jdbcType=VARCHAR},
			RENT_CNT =
			#{RENT_CNT          ,  jdbcType=VARCHAR},
			RENT_USER_NM =
			#{RENT_USER_NM      ,  jdbcType=VARCHAR},
			RENT_PLACE =
			#{RENT_PLACE     	,  jdbcType=VARCHAR},
			RETURN_USER_NM =
			#{RETURN_USER_NM    ,  jdbcType=VARCHAR},
			RETURN_DT =
			#{RETURN_DT			,  jdbcType=VARCHAR},
			REMARK =
			#{REMARK			,  jdbcType=VARCHAR},
			MOD_USR =
			#{MOD_USR       	,  jdbcType=VARCHAR},
			MOD_DT = SYSDATE

     WHERE RENT_SEQ = #{RENT_SEQ}
       AND EQUIPMENT_SEQ = #{EQUIPMENT_SEQ}
	</update>
	
	
    <update id="deleteMngEquipRentInfo" >
	    DELETE FROM TB_RENT_MNG
		 WHERE RENT_SEQ = #{RENT_SEQ}
		   AND EQUIPMENT_SEQ = #{EQUIPMENT_SEQ}
    </update>
	    
	<select id="getUserListByUserID" parameterType="hashMap" resultType="hashMap">
		SELECT USER_ID AS CD, USER_NM ||'('||USER_ID ||')' AS CD_NM 
		FROM TB_USER_INFO
		WHERE 1=1
		<if test="PATIENT_YN != null">
			AND PATIENT_YN = #{PATIENT_YN}
		</if>
		<if test="USER_ID != null">
			AND USER_ID = #{USER_ID}
		</if>
		<if test="USER_TYPE != null">
			AND USER_TYPE IN (100747, 100751)
		</if>
	</select>

    
<!--     <select id="selectCdNmCombo" parameterType="hashMap" resultType="hashMap">
	<![CDATA[
		SELECT CATGR,
		       CD,
		       LPAD(' ', 2 * (LEVEL - 1), '>') || CD_NM  AS CD_NM_PATH,
		       CD_NM,
		       SORT_NO,
		       DEUser(USE_YN,'0','false','true')  USE_YN  , 
		       LEVEL
		  FROM TB_User_MASTER
		 WHERE LEVEL <= 2
		 START WITH CATGR = 0
		CONNECT BY CATGR = PRIOR CD
	]]>
    </select>
    
    <select id="selectMngEquipRentInfoCombo" parameterType="hashMap" resultType="hashMap">
    	<![CDATA[
	    SELECT * 
        FROM TB_User_MASTER 
       ORDER BY SORT_NO
    	]]>
    </select> -->
    
    
    
</mapper>
