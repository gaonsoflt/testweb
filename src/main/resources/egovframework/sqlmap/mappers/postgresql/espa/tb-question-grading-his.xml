<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.espa.service.impl.QuestionGradingHistoryMapper"> 
	<select id="readLatestGradingHistoryByUser" parameterType="hashMap" resultType="hashMap">
		SELECT
			A.deploy_seq as deploy_seq,
			A.user_seq as user_seq,
			A.submit_dt,
			B.score_rate,
			B.grading_order,
			B.exec_time
		FROM TB_QUESTION_ANSWER_HIS A
		LEFT JOIN TB_QUESTION_GRADING_HIS B ON A.DEPLOY_SEQ = B.DEPLOY_SEQ AND A.USER_SEQ = B.USER_SEQ AND A.SUBMIT_DT = B.SUBMIT_DT 
		WHERE A.deploy_seq = CAST(#{deploy_seq} as integer)
		AND A.user_seq = CAST(#{user_seq} as integer)
		AND A.submit_dt = (
			SELECT 
				MAX(submit_dt) 
			FROM TB_QUESTION_ANSWER_HIS
			WHERE deploy_seq = CAST(#{deploy_seq} as integer)
			AND user_seq = CAST(#{user_seq} as integer)
		)
	</select>
	
    <insert id="createGradingHistory" parameterType="egovframework.espa.dao.ESPAExecuteResultVO">
		INSERT INTO tb_question_grading_his(
			deploy_seq,
	      	user_seq,
	      	submit_dt,
	      	exec_time,
	      	score_rate,
	      	grading_order
		) VALUES (
			CAST(#{deploySeq} as integer),
			CAST(#{userSeq} as integer),
			#{submitDt},
			CAST(#{executeTime} as integer),
			CAST(#{socoreRate} as integer),
			CAST(#{gradingOrder} as integer)
		) 
	</insert> 
</mapper>
