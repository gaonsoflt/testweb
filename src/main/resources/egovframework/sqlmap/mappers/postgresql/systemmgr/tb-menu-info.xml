<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.espa.service.impl.SystemMgrMenuMapper">

	<select id="selectMenuInfo" parameterType="hashMap" resultType="hashMap">
		SELECT
			MENU_SQ,
			MENU_NM,
			MENU_URL,
			MENU_DESC,
			MENU_CONTENT,
			MENU_ORDER,
			CASE WHEN USE_YN='1' THEN true ELSE false end USE_YN,
			PARENT_SQ,
			MENU_ID
		FROM tb_menu_info
			WHERE 1 = 1
		<if test="TYPE == 'PARENT'">
   			AND PARENT_SQ IS NULL
		</if>
		<if test="TYPE == 'CHILD'">
   			AND PARENT_SQ = cast(#{MENU_SQ} as integer)
		</if>
		ORDER BY MENU_ORDER
    </select>

	<select id="getMenuInfo" parameterType="hashMap" resultType="hashMap">
		SELECT * 
			FROM (
				SELECT
		  			T.MENU_SQ,
		  			T.PARENT_SQ,
		  			T.MENU_ORDER,
					T.MENU_NM,
					T.MENU_ID,
					T.MENU_URL,
					T.MENU_DESC,
					T.MENU_CONTENT,
					CASE WHEN T.USE_YN = '1' THEN true ELSE false end USE_YN,
					M.MENU_SQ 		AS MAIN_SQ,
				  	M.MENU_ORDER 	AS MAIN_ORDER,
					M.MENU_NM 		AS MAIN_NM,
					M.MENU_ID 		AS MAIN_ID,
					M.MENU_URL 		AS MAIN_URL,
					M.MENU_DESC 	AS MAIN_DESC,
					M.MENU_CONTENT 	AS MAIN_CONTENT,
					CASE WHEN M.USE_YN = '1' THEN true ELSE false end MAIN_USE_YN
				FROM tb_menu_info T, tb_menu_info M
				WHERE 1 = 1
		  			AND T.PARENT_SQ = M.MENU_SQ
		  			AND T.USE_YN = '1' AND M.USE_YN = '1'
			) A, (
				SELECT 
					DISTINCT(MENU_SQ)
				FROM tb_user_auth
	  			WHERE 1 = 1
	  				AND auth_r = '1'
	            	AND (user_type = (SELECT user_type FROM tb_user_info WHERE user_seq = cast(#{USER_NO} as integer)) OR user_no = cast(#{USER_NO} as integer))
			) B
			WHERE A.MENU_SQ = B.MENU_SQ
			ORDER BY main_order, menu_order
    </select>
    
	<insert id="createMenuInfo" >
		INSERT INTO TB_MENU_INFO (
			MENU_SQ			,
			MENU_NM			,
			MENU_URL		,
			MENU_DESC		,
			MENU_CONTENT	,
			MENU_ORDER		,
			USE_YN			,
			PARENT_SQ		,
			MENU_ID
		) VALUES (
			#{MENU_SQ		, jdbcType=NUMERIC},
			#{MENU_NM		, jdbcType=VARCHAR},
			#{MENU_URL		, jdbcType=VARCHAR},
			#{MENU_DESC		, jdbcType=VARCHAR},
			#{MENU_CONTENT	, jdbcType=VARCHAR},
			#{MENU_ORDER	, jdbcType=NUMERIC},
			#{USE_YN		, jdbcType=VARCHAR},
			#{PARENT_SQ		, jdbcType=NUMERIC},
			#{MENU_ID		, jdbcType=VARCHAR}
		) 
	</insert>

	<update id="updateMenuInfo" >
		UPDATE TB_MENU_INFO 
			SET 
				MENU_NM			= #{MENU_NM			, jdbcType=VARCHAR},
				MENU_URL		= #{MENU_URL		, jdbcType=VARCHAR},
				MENU_DESC		= #{MENU_DESC		, jdbcType=VARCHAR},
				MENU_CONTENT	= #{MENU_CONTENT	, jdbcType=VARCHAR},
				MENU_ORDER		= #{MENU_ORDER		, jdbcType=NUMERIC},
				USE_YN			= #{USE_YN			, jdbcType=VARCHAR},
				PARENT_SQ		= #{PARENT_SQ		, jdbcType=NUMERIC},
				MENU_ID			= #{MENU_ID			, jdbcType=VARCHAR}
     	WHERE MENU_SQ = #{MENU_SQ}
	</update>
	
    <delete id="deleteMenuInfo" >
		DELETE FROM TB_MENU_INFO
			WHERE MENU_SQ = #{MENU_SQ}
    </delete>
</mapper>
