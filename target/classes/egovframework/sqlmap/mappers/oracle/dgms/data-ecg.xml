<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.dgms.service.impl.DataEcgMapper">


    <resultMap id="EcgClobMap" type="java.util.HashMap">
		<result property="ECG_SEQ"           column="ECG_SEQ"             />
		<result property="USER_ID"           column="USER_ID"             />
		<result property="MEASURE_DT"        column="MEASURE_DT"          />
		<result property="SMEASURE_DT"       column="SMEASURE_DT"          />
		<result property="RECORD_PERIOD"     column="RECORD_PERIOD"       />
		<result property="MIN_HEART"         column="MIN_HEART"           />
		<result property="MAX_HEART"         column="MAX_HEART"           />
		<result property="AVG_HEART"         column="AVG_HEART"           />
		<result property="FREQ_CNT"          column="FREQ_CNT"            />
		<result property="INFREQ_CNT"        column="INFREQ_CNT"          />
		<result property="MAX_RRS"           column="MAX_RRS"             />
		<result property="UNUSUAL_CNT"       column="UNUSUAL_CNT"         />
		<result property="ECG_RAW_DATA"      column="ECG_RAW_DATA"        />
		<result property="CRE_USR"           column="CRE_USR"             />
		<result property="CRE_DT"            column="CRE_DT"              />
		<result property="MOD_USR"           column="MOD_USR"             />
		<result property="MOD_DT"            column="MOD_DT"              />
		<result property="ECG_RAW_CLOB"      column="ECG_RAW_CLOB"        jdbcType="CLOB" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
	</resultMap>
	
	<resultMap id="ActEcgClobMap" type="java.util.HashMap">
		<result property="ECG_SEQ"           column="ECG_SEQ"             />
		<result property="USER_ID"           column="USER_ID"             />
		<result property="MEASURE_DT"        column="MEASURE_DT"          />
		<result property="SMEASURE_DT"       column="SMEASURE_DT"          />
		<result property="EVENT"     		 column="EVENT"       />
		<result property="PVC_CNT"     		 column="PVC_CNT"       />
		<result property="FREQ_CNT"          column="FREQ_CNT"            />
		<result property="INFREQ_CNT"        column="INFREQ_CNT"          />
		<result property="LEADOFF"       	 column="LEADOFF"         />
		<result property="RPOINT"       	 column="RPOINT"         />
		<result property="BATTERY"       	 column="BATTERY"         />
		<result property="MAXHEART_RATE"     column="MAXHEART_RATE"           />
		<result property="MINHEART_RATE"     column="MINHEART_RATE"           />
		<result property="AVGHEART_RATE"     column="AVGHEART_RATE"           />
		<result property="MAXRRINTERVAL"     column="MAXRRINTERVAL"           />
		<result property="MINRRINTERVAL"     column="MINRRINTERVAL"           />
		<result property="AVGRRINTERVAL"     column="AVGRRINTERVAL"           />
		<result property="ECG_RAW_DATA"      column="ECG_RAW_DATA"        />
		<result property="CRE_USR"           column="CRE_USR"             />
		<result property="CRE_DT"            column="CRE_DT"              />
		<result property="MOD_USR"           column="MOD_USR"             />
		<result property="MOD_DT"            column="MOD_DT"              />
		<result property="ECG_RAW_CLOB"      column="ECG_RAW_CLOB"        jdbcType="CLOB" typeHandler="org.apache.ibatis.type.ClobTypeHandler"/>
	</resultMap>
	
	<select id="selectDataEcgInfo" parameterType="hashMap" resultMap="EcgClobMap">
		<![CDATA[
	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT 
							ECG_SEQ,      
							USER_ID,      
							MEASURE_DT,
							TO_CHAR(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS') SMEASURE_DT,    
							RECORD_PERIOD,
							MIN_HEART,    
							MAX_HEART,    
							AVG_HEART,    
							FREQ_CNT,     
							INFREQ_CNT,   
							MAX_RRS,      
							UNUSUAL_CNT,  
							ECG_RAW_DATA, 
							CRE_USR,      
							CRE_DT,       
							MOD_USR,      
							MOD_DT,       
							ECG_RAW_CLOB
	                      FROM TB_ECG_MEASURE_IF 
	                     WHERE 1=1
	                     AND (USER_ID=#{user_id} OR USER_ID IN(SELECT USER_ID FROM TB_GROUP_MNG WHERE PAT_RELATION='100777' AND TRIM(GRPMBR_ID)=#{user_id}))
	     ]]>
	                     <if test="mdate != null and mdate != ''">
							<![CDATA[
						       AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') = #{mdate}
					    	]]>
						</if>
						<if test="fromdate != null and fromdate != ''">
								<![CDATA[ AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') >= #{fromdate} ]]>
						</if>
						<if test="todate != null and todate != ''">
							 <![CDATA[ AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') <= #{todate} ]]>
						</if>
		<![CDATA[
	                     ORDER BY MEASURE_DT DESC
	                     ) A
	           ) A
	     WHERE 1 = 1
	     ]]>
	     
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>
		ORDER BY MEASURE_DT DESC
    </select>
    
    <select id="selectEcgInfoBySeq" parameterType="hashMap" resultMap="EcgClobMap">
	    SELECT 
			ECG_SEQ,      
			USER_ID,      
			MEASURE_DT,   
			RECORD_PERIOD,
			MIN_HEART,    
			MAX_HEART,    
			AVG_HEART,    
			FREQ_CNT,     
			INFREQ_CNT,   
			MAX_RRS,      
			UNUSUAL_CNT,  
			ECG_RAW_DATA, 
			CRE_USR,      
			CRE_DT,       
			MOD_USR,      
			MOD_DT,       
			ECG_RAW_CLOB
                   FROM TB_ECG_MEASURE_IF 
                  WHERE 1=1 AND ECG_SEQ=#{ecg_seq}
    </select>
    <select id="selectmobiledayecgData" parameterType="hashMap" resultMap="EcgClobMap">
	    SELECT 
			ECG_SEQ,      
			USER_ID,      
			MEASURE_DT,   
			TO_CHAR(MEASURE_DT,'HH24') action_hour,
            TO_CHAR(MEASURE_DT,'MI') action_minute,
			RECORD_PERIOD,
			MIN_HEART,    
			MAX_HEART,    
			AVG_HEART,    
			FREQ_CNT,     
			INFREQ_CNT,   
			MAX_RRS,      
			UNUSUAL_CNT,  
			ECG_RAW_DATA, 
			CRE_USR,      
			CRE_DT,       
			MOD_USR,      
			MOD_DT,       
			ECG_RAW_CLOB
                   FROM TB_ECG_MEASURE_IF 
                   WHERE 1=1 
        AND (USER_ID=#{user_id} OR USER_ID IN(SELECT USER_ID FROM TB_GROUP_MNG WHERE PAT_RELATION='100777' AND TRIM(GRPMBR_ID)=#{user_id}))
		       AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') = #{mdate}
		       ORDER BY MEASURE_DT DESC
    </select>
    
<!--     <select id="selectDataEcgInfo" parameterType="hashMap" resultType="hashMap">

	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT 
							*
	                      FROM TB_ECG_MEASURE_IF 
	                     WHERE 1=1
	                     ) A
	           ) A
	     WHERE 1 = 1
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>

    </select> -->
    
    
    <select id="selectDataEcgInfoTot" parameterType="hashMap" resultType="int">

	    SELECT COUNT(*)
	      FROM TB_ECG_MEASURE_IF
	     WHERE 1 = 1 AND (USER_ID=#{user_id} OR USER_ID IN(SELECT USER_ID FROM TB_GROUP_MNG WHERE PAT_RELATION='100777' AND TRIM(GRPMBR_ID)=#{user_id}))
	     <if test="mdate != null and mdate != ''">
			<![CDATA[
		       AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') = #{mdate}
	    	]]>
		</if>
		<if test="fromdate != null and fromdate != ''">
				<![CDATA[ AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') >= #{fromdate} ]]>
		</if>
		<if test="todate != null and todate != ''">
			 <![CDATA[ AND TO_CHAR(MEASURE_DT,'YYYY-MM-DD') <= #{todate} ]]>
		</if>
    </select>
    
    
    <insert id="insertEcgData">
	 	INSERT INTO TB_ECG_MEASURE_IF (ECG_SEQ,
		   AVG_HEART, ECG_RAW_DATA, USER_ID, 
		   FREQ_CNT, INFREQ_CNT, 
		   CRE_DT, CRE_USR,MOD_DT,MOD_USR, MAX_HEART, 
		   MAX_RRS, MEASURE_DT, MIN_HEART, 
		   RECORD_PERIOD, UNUSUAL_CNT,ECG_RAW_CLOB) 
		VALUES ( SEQ_ECG_MEASURE_IF.nextval,#{AVG_HEART},
		 #{ECG_RAW_DATA},
		 #{USER_ID},
		 #{FREQ_CNT},
		 #{INFREQ_CNT},
		 sysdate,
		 #{CRE_USR},
		 sysdate,
		 #{CRE_USR},
		 #{MAX_HEART},
		 #{MAX_RRS},
		 to_date(#{MEASURE_DT},'YYYY-MM-DD HH24:MI:SS'),
		 #{MIN_HEART},
		 #{RECORD_PERIOD},
		 #{UNUSUAL_CNT},
		 #{ECG_RAW_CLOB})
	 </insert>
    
    <insert id="insertActEcgData">
	 	INSERT INTO TB_ACTECG_MEASURE_IF (ECG_SEQ,
	 		USER_ID, MEASURE_DT, EVENT, FREQ_CNT, INFREQ_CNT,
	 		LEADOFF, RPOINT, BATTERY, MAXHEART_RATE, MINHEART_RATE,
	 		AVGHEART_RATE, MAXRRINTERVAL, MINRRINTERVAL, AVGRRINTERVAL,
	 		ECG_RAW_DATA, CRE_USR, CRE_DT, MOD_USR, MOD_DT, 
	 		ECG_RAW_CLOB, PVC_CNT) 
		VALUES (SEQ_ACTECG_MEASURE_IF.nextval,
			#{USER_ID},
			#{MEASURE_DT},
			#{EVENT},
			#{FREQ_CNT},
			#{INFREQ_CNT},
			#{LEADOFF},
			#{RPOINT},
			#{BATTERY},
			#{MAXHEART_RATE},
			#{MINHEART_RATE},
			#{AVGHEART_RATE},
			#{MAXRRINTERVAL},
			#{MINRRINTERVAL},
			#{AVGRRINTERVAL},
			#{ECG_RAW_DATA},
			#{CRE_USR},
			sysdate,
			#{CRE_USR},
			sysdate,
			#{ECG_RAW_CLOB},
			#{PVC_CNT})
	 </insert>
	 
    <select id="selectDataActEcgInfo" parameterType="hashMap" resultMap="ActEcgClobMap">
		<![CDATA[
	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT 
							ECG_SEQ,      
							USER_ID,      
							MEASURE_DT,
							TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD HH24:MI:SS') SMEASURE_DT,    
							EVENT, FREQ_CNT, INFREQ_CNT, PVC_CNT,
						   LEADOFF, RPOINT, BATTERY, 
						   MAXHEART_RATE, MINHEART_RATE, AVGHEART_RATE, 
						   MAXRRINTERVAL, MINRRINTERVAL, AVGRRINTERVAL, 
						   ECG_RAW_DATA, CRE_USR, CRE_DT, 
						   MOD_USR, MOD_DT, ECG_RAW_CLOB
	                      FROM TB_ACTECG_MEASURE_IF 
	                     WHERE 1=1
	                     AND (USER_ID=#{user_id} OR USER_ID IN(SELECT USER_ID FROM TB_GROUP_MNG WHERE PAT_RELATION='100777' AND TRIM(GRPMBR_ID)=#{user_id}))
	     ]]>
	                     <if test="mdate != null and mdate != ''">
							<![CDATA[
						       AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') = #{mdate}
					    	]]>
						</if>
						<if test="fromdate != null and fromdate != ''">
								<![CDATA[ AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') >= #{fromdate} ]]>
						</if>
						<if test="todate != null and todate != ''">
							 <![CDATA[ AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') <= #{todate} ]]>
						</if>
		<![CDATA[
	                     ORDER BY MEASURE_DT DESC
	                     ) A
	           ) A
	     WHERE 1 = 1
	     ]]>
	     
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>
		ORDER BY MEASURE_DT DESC
    </select>
    
    <select id="selectDataActEcgInfoTot" parameterType="hashMap" resultType="int">

	    SELECT COUNT(*)
	      FROM TB_ACTECG_MEASURE_IF
	     WHERE 1 = 1 AND (USER_ID=#{user_id} OR USER_ID IN(SELECT USER_ID FROM TB_GROUP_MNG WHERE PAT_RELATION='100777' AND TRIM(GRPMBR_ID)=#{user_id}))
	     <if test="mdate != null and mdate != ''">
			<![CDATA[
		       AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') = #{mdate}
	    	]]>
		</if>
		<if test="fromdate != null and fromdate != ''">
				<![CDATA[ AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') >= #{fromdate} ]]>
		</if>
		<if test="todate != null and todate != ''">
			 <![CDATA[ AND TO_CHAR(TO_DATE(MEASURE_DT,'YYYY-MM-DD HH24:MI:SS'),'YYYY-MM-DD') <= #{todate} ]]>
		</if>
    </select>
    
    <select id="selectActEcgInfoBySeq" parameterType="hashMap" resultMap="ActEcgClobMap">
	    SELECT 
			ECG_SEQ, USER_ID, MEASURE_DT, PVC_CNT,
		   EVENT, FREQ_CNT, INFREQ_CNT, 
		   LEADOFF, RPOINT, BATTERY, 
		   MAXHEART_RATE, MINHEART_RATE, AVGHEART_RATE, 
		   MAXRRINTERVAL, MINRRINTERVAL, AVGRRINTERVAL, 
		   ECG_RAW_DATA, CRE_USR, CRE_DT, 
		   MOD_USR, MOD_DT, ECG_RAW_CLOB
                   FROM TB_ACTECG_MEASURE_IF 
                  WHERE 1=1 AND ECG_SEQ=#{ecg_seq}
    </select>
</mapper>
