<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.dgms.service.impl.MyPageMapper">


	
    
    <select id="selectMyPageInfo" parameterType="hashMap" resultType="hashMap">

	    SELECT *
	      FROM (SELECT ROWNUM RNUM, A.*
	              FROM (SELECT 
	              			B.CHECKUP_TYPE,
	              			B.HOSP_NM,
	              			B.DOCTOR_NM,
	              			B.CHECKUP_DT,
	              			B.OPINION_WRITER,
	              			B.OPINION,
	              			C.CHECKUP_TYPE AS CHECKUP_TYPE_ECR,
			              	C.HOSP_NM AS HOSP_NM_ECR,
			              	C.DOCTOR_NM AS DOCTOR_NM_ECR,
			              	C.CHECKUP_DT AS CHECKUP_DT_ECR,
			              	C.OPINION_WRITER AS OPINION_WRITER_ECR,
			              	C.OPINION AS OPINION_ECR,
			              	C.MOD_DT,
							A.USER_SEQ    ,
							A.AREA_ID     ,
							A.USER_NM     ,
							A.MOBILE_NO   ,
							A.USER_ID     ,
							A.LOGIN_PWD   ,
							A.SEX         ,
							A.BIRTHDAY    ,
							A.ADDR_CIDO   ,
							A.ADDR_CIGUNGU,
							A.USER_TYPE   ,
							DECODE(A.USE_YN,'0','false','true')  USE_YN  , 
							A.PATIENT_YN ,
							A.AUTH_TYPE   ,
							A.CRE_USR     ,
							A.CRE_DT      ,
							A.MOD_USR     ,
							--A.MOD_DT      ,
							A.ADDR_DETAIL
	                      FROM TB_USER_INFO A
	                      LEFT JOIN TB_CHECKUP_OPINION B
	                        ON B.USER_ID = A.USER_ID
   						   AND B.CHECKUP_TYPE = '101041'
   						  LEFT JOIN TB_CHECKUP_OPINION C
				            ON C.USER_ID = B.USER_ID
				           AND C.CHECKUP_TYPE = '101043'
	                     WHERE 1=1
	                     <if test='AREA_ID != null'>
	                       AND REPLACE(A.AREA_ID, 000000, '') LIKE REPLACE(#{AREA_ID}, 000000, '') || '%'
	                     </if> 
	                     <if test='USER_ID != null'>
				          AND A.USER_ID = #{USER_ID}
				        </if>
	                     <if test='USER_NM != null'>
	                       AND A.USER_NM = #{USER_NM}
	                     </if>  
	                     <if test='PATIENT_YN != null'>
	                       AND A.PATIENT_YN = #{PATIENT_YN}
	                     </if>  
	                     ORDER BY C.MOD_DT DESC
	                     ) A
	           ) A
	     WHERE 1 = 1
	       AND ROWNUM = 1
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>

    </select>
    
    
    <select id="selectMyPageInfoTot" parameterType="hashMap" resultType="int">

	    SELECT  COUNT(*)
           FROM TB_USER_INFO A
           JOIN TB_CHECKUP_OPINION B
             ON B.USER_ID = A.USER_ID
			AND B.CHECKUP_TYPE = '101041'
          WHERE 1=1
          <if test='AREA_ID != null'>
            AND REPLACE(A.AREA_ID, 000000, '') LIKE REPLACE(#{AREA_ID}, 000000, '') || '%'
          </if> 
          <if test='USER_ID != null'>
		    AND A.USER_ID = #{USER_ID}
		  </if>
          <if test='USER_NM != null'>
            AND A.USER_NM = #{USER_NM}
          </if>  
          <if test='PATIENT_YN != null'>
            AND A.PATIENT_YN = #{PATIENT_YN}
          </if>  
          ORDER BY A.USER_NM
          
    </select>
    
    <update id="updateMyPageInfo" >
	
    UPDATE TB_USER_INFO
       SET  LOGIN_PWD   = #{NEW_PWD     ,  jdbcType=VARCHAR},
			MOD_USR     = #{MOD_USR       ,  jdbcType=VARCHAR},
			MOD_DT      = SYSDATE		
     WHERE USER_SEQ = #{USER_SEQ}
	</update>
    
    
<!--     <select id="selectCdNmCombo" parameterType="hashMap" resultType="hashMap">
	<![CDATA[
		SELECT CATGR,
		       CD,
		       LPAD(' ', 2 * (LEVEL - 1), '>') || CD_NM  AS CD_NM_PATH,
		       CD_NM,
		       SORT_NO,
		       DEUser(USE_YN,'0','false','true')  USE_YN  , 
		       LEVEL
		  FROM TB_User_MASTER
		 WHERE LEVEL <= 2
		 START WITH CATGR = 0
		CONNECT BY CATGR = PRIOR CD
	]]>
    </select>
    
    <select id="selectMyPageInfoCombo" parameterType="hashMap" resultType="hashMap">
    	<![CDATA[
	    SELECT * 
        FROM TB_User_MASTER 
       ORDER BY SORT_NO
    	]]>
    </select> -->
    
    
    
</mapper>
