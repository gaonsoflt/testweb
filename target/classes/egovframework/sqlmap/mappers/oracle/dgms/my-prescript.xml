<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.dgms.service.impl.MyPrescriptMapper">

    <select id="selectMyPrescriptInfo" parameterType="hashMap" resultType="hashMap">
		<![CDATA[
		SELECT	PRSC_SEQ, 
				A.USER_ID,
				PRSC_STDT,
				PRSC_PERIOD
		FROM	TB_PRESCRIPT_IF A
				LEFT OUTER JOIN TB_USER_INFO B
				ON A.USER_ID = B.USER_ID
		        LEFT OUTER JOIN TB_CODE_MASTER C 
		        ON B.AREA_ID = C.CD_ID
		WHERE	1=1
				AND PATIENT_YN ='1'
		]]>	 
		<if test='PRSC_STDT != null'>
			AND A.PRSC_STDT LIKE '%'||#{PRSC_STDT}||'%'
		</if>	
		<if test='AREA_ID != null'> 
	        AND C.CATGR = '100703'  
            AND (   C.CD_ID = #{AREA_ID}
               	 	OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
             )
		</if>
		<if test="USER_ID != null">
			AND A.USER_ID = #{USER_ID}
		</if>
		<if test='USER_NM != null'>
			AND B.USER_NM LIKE '%'||#{USER_NM}||'%'
		</if>		
		ORDER BY B.USER_NM ASC,PRSC_STDT DESC
    </select>
    
    
    <select id="selectMyPrescriptInfoTot" parameterType="hashMap" resultType="int">
	    SELECT COUNT(*)
	      FROM TB_PRESCRIPT_IF
	      <if test="USER_ID != null">
			AND USER_ID = #{USER_ID}
		</if>
    </select>
    
    
    <insert id="insertMyPrescriptInfo" >
	    INSERT INTO TB_PRESCRIPT_IF
	      (PRSC_SEQ, USER_ID, PRSC_STDT, PRSC_PERIOD, APPLY_YN, AREA_ID, CRE_USR, CRE_DT)
	    VALUES
	      (  SEQ_PRESCRIPT_IF.NEXTVAL,
	       #{USER_ID, jdbcType=VARCHAR},
	       #{PRSC_STDT, jdbcType=VARCHAR},
	       #{PRSC_PERIOD, jdbcType=INTEGER},
	       'Y',
	       #{AREA_ID, jdbcType=VARCHAR},
	       #{CRE_USR, jdbcType=VARCHAR},
	       SYSDATE
	       ) 
	</insert>
	
	
    <update id="deleteMyPrescriptInfo" >
	    DELETE FROM TB_PRESCRIPT_IF
		 WHERE PRSC_SEQ = #{PRSC_SEQ}
    </update>
    
    
	<update id="updateMyPrescriptInfo" >
	    UPDATE TB_PRESCRIPT_IF
	       SET USER_ID = #{USER_ID, jdbcType=VARCHAR}
	          ,PRSC_STDT = #{PRSC_STDT, jdbcType=VARCHAR}
	          ,PRSC_PERIOD = #{PRSC_PERIOD, jdbcType=INTEGER}
	          ,MOD_USR = #{MOD_USR, jdbcType=VARCHAR}
	          ,MOD_DT = SYSDATE
	     WHERE PRSC_SEQ = #{PRSC_SEQ}
	</update>
    
    
    <select id="selectMyPrescriptMedcInfo" parameterType="hashMap" resultType="hashMap">
		SELECT * 
		FROM (
		    SELECT ROWNUM RNUM, A.*
		    FROM (
		        SELECT  PRSCMEDC_SEQ,
		                PRSC_SEQ,
		                PRSCMEDC_CD,
		                PRSCMEDC_NM,
		                DOSAGE,
		                DOSAGE_ONCE,
		                DOSAGE_ONCE_DAY,
		                USAGE        
		        FROM TB_PRESCRIPT_MEDC_IF
		        WHERE 1=1
		        <if test='PRSC_SEQ != null'>
		        	AND PRSC_SEQ = #{PRSC_SEQ}
		        </if>
		        <if test="USER_ID != null">
					AND CRE_USR = #{USER_ID}
				</if>
		        ) A
		    ) A
		WHERE 1=1 
		<if test='PAGE != null'>
		<![CDATA[
	       AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
	       AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>
    </select>
    
    
    <select id="selectMyPrescriptMedcInfoTot" parameterType="hashMap" resultType="int">
	    SELECT COUNT(*)
	      FROM TB_PRESCRIPT_MEDC_IF
	     WHERE 1 = 1
		<if test='PRSC_SEQ != null'>
		 AND PRSC_SEQ = #{PRSC_SEQ}
		</if>  
		<if test="USER_ID != null">
			AND CRE_USR = #{USER_ID}
		</if>
    </select>
    
    
    <insert id="insertMyPrescriptMedcInfo" >
	    INSERT INTO TB_PRESCRIPT_MEDC_IF
	      (PRSCMEDC_SEQ, PRSC_SEQ, PRSCMEDC_CD, PRSCMEDC_NM, DOSAGE, DOSAGE_ONCE, DOSAGE_ONCE_DAY, USAGE, CRE_USR, CRE_DT)
	    VALUES
	      (  SEQ_PRESCRIPT_MEDC_IF.NEXTVAL,
	       #{PRSC_SEQ, jdbcType=VARCHAR},
	       #{PRSCMEDC_CD, jdbcType=VARCHAR},
	       #{PRSCMEDC_NM, jdbcType=VARCHAR},
	       #{DOSAGE, jdbcType=INTEGER},
	       #{DOSAGE_ONCE, jdbcType=INTEGER},
	       #{DOSAGE_ONCE_DAY, jdbcType=INTEGER},
	       #{USAGE, jdbcType=VARCHAR},
	       #{CRE_USR, jdbcType=VARCHAR},
	       SYSDATE
	       ) 
	</insert>
	
	
    <update id="deleteMyPrescriptMedcInfo" >
	    DELETE FROM TB_PRESCRIPT_MEDC_IF
		 WHERE PRSCMEDC_SEQ = #{PRSCMEDC_SEQ}
		 AND PRSC_SEQ = #{PRSC_SEQ}
    </update>
    
    
	<update id="updateMyPrescriptMedcInfo" >
	    UPDATE TB_PRESCRIPT_MEDC_IF
	       SET PRSCMEDC_CD = #{PRSCMEDC_CD, jdbcType=VARCHAR}
	          ,PRSCMEDC_NM = #{PRSCMEDC_NM, jdbcType=VARCHAR}
	          ,DOSAGE = #{DOSAGE, jdbcType=INTEGER}
	          ,DOSAGE_ONCE = #{DOSAGE_ONCE, jdbcType=INTEGER}
	          ,DOSAGE_ONCE_DAY = #{DOSAGE_ONCE_DAY, jdbcType=INTEGER}
	          ,USAGE = #{USAGE, jdbcType=VARCHAR}
	          ,MOD_USR = #{MOD_USR, jdbcType=VARCHAR}
	          ,MOD_DT = SYSDATE
	     WHERE PRSCMEDC_SEQ = #{PRSCMEDC_SEQ}
	       AND PRSC_SEQ = #{PRSC_SEQ}
	</update>
	
	<select id="selectdosageData" parameterType="hashMap" resultType="hashMap">
    	<![CDATA[
			SELECT PRSC_SEQ,A.USER_ID,PRSC_STDT,PRSC_PERIOD,TO_CHAR (TO_DATE (PRSC_STDT, 'yyyymmdd')+PRSC_PERIOD,'YYYYMMDD') PRSC_EDDT,C.EQUIPMENT_ID FROM TB_PRESCRIPT_IF A
			JOIN TB_RENT_MNG B ON A.USER_ID=B.USER_ID JOIN TB_EQUIPMENT_INFO C ON B.EQUIPMENT_SEQ=C.EQUIPMENT_SEQ
			WHERE ROWNUM =1 
		 ]]>
			<if test='PRSC_SEQ != null'>
			 AND PRSC_SEQ = #{PRSC_SEQ}
			</if> 
			<if test='USER_ID != null'>
			 AND USER_ID = #{user_id}
			</if> 
		<![CDATA[
			 AND RENT_STATE='101074' AND EQUIP_TYPE='100756'
			ORDER BY PRSC_STDT DESC 
        ]]>
    </select>
    <select id="selectdosagealarmData" parameterType="hashMap" resultType="hashMap">
    	<![CDATA[
			WITH tmpCTE AS (
			SELECT PRSC_SEQ,A.USER_ID,PRSC_STDT,PRSC_PERIOD,TO_CHAR (TO_DATE (PRSC_STDT, 'yyyymmdd')+PRSC_PERIOD,'YYYYMMDD') PRSC_EDDT,C.EQUIPMENT_ID FROM TB_PRESCRIPT_IF A
			JOIN TB_RENT_MNG B ON A.USER_ID=B.USER_ID JOIN TB_EQUIPMENT_INFO C ON B.EQUIPMENT_SEQ=C.EQUIPMENT_SEQ
			WHERE ROWNUM =1 
			]]>
			<if test='PRSC_SEQ != null'>
			 AND A.PRSC_SEQ = #{PRSC_SEQ}
			</if> 
			<if test='USER_ID != null'>
			 AND A.USER_ID=#{user_id} 
			</if> 
		<![CDATA[
			AND RENT_STATE='101074' AND EQUIP_TYPE='100756'
			ORDER BY PRSC_STDT DESC 
			), maxDOSAGE AS
			(
			    SELECT MAX(DOSAGE_ONCE) MAXDOSAGE_ONCE FROM TB_PRESCRIPT_MEDC_IF
			    WHERE PRSC_SEQ=(SELECT PRSC_SEQ FROM tmpCTE WHERE ROWNUM=1)
			)
			SELECT A.*,MAXDOSAGE_ONCE,(SELECT EQUIPMENT_ID FROM tmpCTE WHERE ROWNUM=1) EQUIPMENT_ID FROM TB_PRESCRIPT_MEDC_IF A,maxDOSAGE
			WHERE PRSC_SEQ=(SELECT PRSC_SEQ FROM tmpCTE WHERE ROWNUM=1)
        ]]>
    </select>
</mapper>
<!-- 
		SELECT CATGR,
		       CD,
		       LPAD(' ', 2 * (LEVEL - 1), '>') || CD_NM  AS CD_NM_PATH,
		       CD_NM,
		       SORT_NO,
		       DECODE(USE_YN,'0','false','true')  USE_YN  , 
		       LEVEL
		  FROM TB_CODE_MASTER
		 WHERE LEVEL <= 2
		 ]]>
		 <if test='CATGR_NM != null'>
		   AND CD_NM LIKE '%' || #{CATGR_NM} || '%'
		 </if>
		 START WITH CATGR = 0
		CONNECT BY CATGR = PRIOR CD
		 ORDER SIBLINGS BY TO_NUMBER(CATGR), TO_NUMBER(CD)

 -->