<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.dgms.service.impl.MoniteringMapper">
 
 
	<!-- 차트 -->
	<!-- 
	 AND (   CD = #{AREA_ID}
     		 OR   CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
     ) 
	 -->
	<!-- 101370 댁내용 심전도계 / 100754    심전도계 / 100755    혈압계 / 100756   디지털약상자 --> 
    <select id="selectChartDataMornitering" parameterType="hashMap" resultType="hashMap">
            SELECT 'A' AS STATE, 
                    COUNT(CASE WHEN EQUIP_TYPE='100756' THEN EQUIP_TYPE ELSE NULL END) AS CNT1,
                    COUNT(CASE WHEN EQUIP_TYPE='100754' THEN EQUIP_TYPE ELSE NULL END) AS CNT2,
                    COUNT(CASE WHEN EQUIP_TYPE='101370' THEN EQUIP_TYPE ELSE NULL END) AS CNT3,
                    COUNT(CASE WHEN EQUIP_TYPE='100755' THEN EQUIP_TYPE ELSE NULL END) AS CNT4  
            FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
		 						AND (   CD = #{AREA_ID}
	     								OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
	     						)
                        </if>
                    ) A 
            WHERE   A.EQUIP_STATE = '101069' 
            
            
            
            UNION
            
            
            
            SELECT 'B' AS STATE,
                    COUNT(CASE WHEN EQUIP_TYPE='100756' THEN EQUIP_TYPE ELSE NULL END) AS CNT1,
                    COUNT(CASE WHEN EQUIP_TYPE='100754' THEN EQUIP_TYPE ELSE NULL END) AS CNT2,
                    COUNT(CASE WHEN EQUIP_TYPE='101370' THEN EQUIP_TYPE ELSE NULL END) AS CNT3,
                    COUNT(CASE WHEN EQUIP_TYPE='100755' THEN EQUIP_TYPE ELSE NULL END) AS CNT4  
            FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A 
            WHERE   A.EQUIP_STATE = '101070' 
            
            
            
            UNION
            
            
            
            SELECT 'C' AS STATE,
                    COUNT(CASE WHEN EQUIP_TYPE='100756' THEN EQUIP_TYPE ELSE NULL END) AS CNT1,
                    COUNT(CASE WHEN EQUIP_TYPE='100754' THEN EQUIP_TYPE ELSE NULL END) AS CNT2,
                    COUNT(CASE WHEN EQUIP_TYPE='101370' THEN EQUIP_TYPE ELSE NULL END) AS CNT3,
                    COUNT(CASE WHEN EQUIP_TYPE='100755' THEN EQUIP_TYPE ELSE NULL END) AS CNT4  
            FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A 
            WHERE   A.EQUIP_STATE = '101071'
            
            
            
            UNION
            
            
            
            SELECT 'D' AS STATE, 
                    COUNT(CASE WHEN EQUIP_TYPE='100756' THEN EQUIP_TYPE ELSE NULL END) AS CNT1,
                    COUNT(CASE WHEN EQUIP_TYPE='100754' THEN EQUIP_TYPE ELSE NULL END) AS CNT2,
                    COUNT(CASE WHEN EQUIP_TYPE='101370' THEN EQUIP_TYPE ELSE NULL END) AS CNT3,
                    COUNT(CASE WHEN EQUIP_TYPE='100755' THEN EQUIP_TYPE ELSE NULL END) AS CNT4  
            FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A 
            
            ORDER BY STATE ASC
    </select>
	 
	<!-- 총수량 집계 -->
    <select id="selectMorniteringData1" parameterType="hashMap" resultType="hashMap">
		    SELECT  
     		    COUNT(*) ALE, 
		        COUNT(CASE WHEN EQUIP_TYPE = '100756' THEN EQUIP_TYPE ELSE NULL END) MEDC,
		        COUNT(CASE WHEN EQUIP_TYPE = '101370' THEN EQUIP_TYPE ELSE NULL END) ECG_1,
		        COUNT(CASE WHEN EQUIP_TYPE = '100754' THEN EQUIP_TYPE ELSE NULL END) ECG_2,
		        COUNT(CASE WHEN EQUIP_TYPE = '100755' THEN EQUIP_TYPE ELSE NULL END) BLDPRS
			FROM    TB_EQUIPMENT_INFO A
			        LEFT OUTER JOIN TB_CODE_MASTER B 
			        ON A.AREA_ID = B.CD_ID
			WHERE   1=1
			        AND EQUIP_TYPE IN ('100755', '101370', '100754', '100756')
				<if test="AREA_ID != null">
			        AND B.CATGR = '100703'  
                    AND (   CD = #{AREA_ID}
	                        OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                        )
				</if>
    </select>
    
	<!-- 기기 상태  -->	
    <select id="selectMorniteringData2" parameterType="hashMap" resultType="hashMap">
			--약상자
			SELECT
				'1' AS SORT,
			        '디지털약상자' AS TITLE,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101069' THEN A.EQUIPMENT_SEQ ELSE NULL END) NOR,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101070' THEN A.EQUIPMENT_SEQ ELSE NULL END) DAM,  
			        COUNT(CASE WHEN A.EQUIP_STATE = '101071' THEN A.EQUIPMENT_SEQ ELSE NULL END) REP,
			        COUNT(*) ALE
			FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A 
			WHERE   1=1
			        AND A.EQUIP_TYPE = '100756' 
			
			
			--심전도1
			UNION
			
			SELECT
				'2' AS SORT,
			        '댁내용 심전도계' AS TITLE,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101069' THEN A.EQUIPMENT_SEQ ELSE NULL END) NOR,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101070' THEN A.EQUIPMENT_SEQ ELSE NULL END) DAM,  
			        COUNT(CASE WHEN A.EQUIP_STATE = '101071' THEN A.EQUIPMENT_SEQ ELSE NULL END) REP,
			        COUNT(*) ALE
			FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A     
			WHERE   1=1
			        AND A.EQUIP_TYPE = '101370' 
			        
			--심전도2
			
			UNION
			
			SELECT  
				'3' AS SORT,
			        '활동용 심전도계' AS TITLE,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101069' THEN A.EQUIPMENT_SEQ ELSE NULL END) NOR,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101070' THEN A.EQUIPMENT_SEQ ELSE NULL END) DAM,  
			        COUNT(CASE WHEN A.EQUIP_STATE = '101071' THEN A.EQUIPMENT_SEQ ELSE NULL END) REP,
			        COUNT(*) ALE
			FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A  
			WHERE   1=1
			        AND A.EQUIP_TYPE = '100754' 
			
			--혈압계
			
			UNION
			
			SELECT  
				'4' AS SORT,
			        '혈압계' AS TITLE,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101069' THEN A.EQUIPMENT_SEQ ELSE NULL END) NOR,
			        COUNT(CASE WHEN A.EQUIP_STATE = '101070' THEN A.EQUIPMENT_SEQ ELSE NULL END) DAM,  
			        COUNT(CASE WHEN A.EQUIP_STATE = '101071' THEN A.EQUIPMENT_SEQ ELSE NULL END) REP,
			        COUNT(*) ALE
			FROM    (   
			            SELECT  * 
						FROM    TB_EQUIPMENT_INFO A
						        LEFT OUTER JOIN TB_CODE_MASTER B 
						        ON A.AREA_ID = B.CD_ID
						WHERE   1=1 
                        <if test="AREA_ID != null">
						        AND B.CATGR = '100703'  
                                AND (   CD = #{AREA_ID}
                              			OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
                                    )
                        </if>
                    ) A 
			WHERE   1=1
			        AND A.EQUIP_TYPE = '100755' 														
    </select>
     
	<!-- 환자별 대여 상태  -->
	<!-- 
		TB_RENT_MNG는 AREA를 CD로 두고 있음
	 -->
    <select id="selectMorniteringData3"  parameterType="hashMap" resultType="hashMap">
			SELECT *
			FROM (
			    SELECT A.*
				FROM(
				    SELECT RENT_USER_NM,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100756' THEN B.EQUIP_TYPE ELSE NULL END) AS MEDC,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '101370' THEN B.EQUIP_TYPE ELSE NULL END) AS ECG_1,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100754' THEN B.EQUIP_TYPE ELSE NULL END) AS ECG_2,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100755' THEN B.EQUIP_TYPE ELSE NULL END) AS BLDPRS,
				           COUNT(*) AS ALE
				    FROM (   
				            SELECT  * 
							FROM (
									 SELECT * 
		                             FROM(   
		                                SELECT  ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_SEQ ORDER BY RENT_DT DESC) AS RN, A.*, B.CD, B.CATGR, B.CD_ID
		                                FROM    TB_RENT_MNG A
		                                        LEFT OUTER JOIN TB_CODE_MASTER B 
		                                        ON A.AREA_ID = B.CD_ID 
		                            	) 
		                            WHERE RN=1
	                        )
							WHERE   1=1 
	                        <if test="AREA_ID != null">
							        AND CATGR = '100703'  
	                                AND (   CD = #{AREA_ID}
							                OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
	                                    )
	                        </if>
	                    ) A 
				         LEFT OUTER JOIN TB_EQUIPMENT_INFO B
				         ON A.EQUIPMENT_SEQ = B.EQUIPMENT_SEQ
				    GROUP BY USER_ID, RENT_USER_NM
				) A
			)
			WHERE 1=1 
   		    <if test="G_EquipmentVal neq 'ALL'"> 
				<if test="G_EquipmentVal eq 'MEDC'"> AND MEDC > 0 </if>
				<if test="G_EquipmentVal eq 'ECG_1'"> AND ECG_1 > 0 </if>
				<if test="G_EquipmentVal eq 'ECG_2'"> AND ECG_2 > 0 </if>
				<if test="G_EquipmentVal eq 'BLDPRS'"> AND BLDPRS > 0 </if>
			</if>
    </select>

    
	<!-- 기기 대여/재고 상태  -->
    <select id="selectMorniteringDataCNT1"  parameterType="hashMap" resultType="hashMap">
		SELECT	COUNT(CASE WHEN RENT_SEQ IS NULL THEN A.EQUIPMENT_SEQ ELSE NULL END) AS NRENTC,
				COUNT(CASE WHEN RENT_SEQ IS NOT NULL THEN RENT_SEQ ELSE NULL END) RENTC
		FROM
            TB_EQUIPMENT_INFO A 
            LEFT OUTER JOIN (
                SELECT * 
                FROM(   
                    SELECT  ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_SEQ ORDER BY RENT_DT DESC) AS RN, A.*, B.CD, B.CATGR, B.CD_ID
                    FROM    TB_RENT_MNG A
                    LEFT OUTER JOIN TB_CODE_MASTER B 
                    ON A.AREA_ID = B.CD_ID 
                ) 
                WHERE RN=1
            ) B 
            ON A.EQUIPMENT_SEQ = B.EQUIPMENT_SEQ 
		WHERE 1=1   
		<if test="AREA_ID != null"> 
     		AND A.AREA_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%' 
		</if>
  		<if test="G_EquipmentVal neq 'ALL'"> 
			<if test="G_EquipmentVal eq 'MEDC'"> AND EQUIP_TYPE='100756'</if>
			<if test="G_EquipmentVal eq 'ECG_1'"> AND EQUIP_TYPE='101370'</if>
			<if test="G_EquipmentVal eq 'ECG_2'"> AND EQUIP_TYPE='100754'</if>
			<if test="G_EquipmentVal eq 'BLDPRS'"> AND EQUIP_TYPE='100755'</if>
		</if>
    </select> 
    
    <select id="selectMorniteringData3Tot" parameterType="hashMap" resultType="int">
		SELECT COUNT(*)
			FROM (
			    SELECT A.*
				FROM(
				    SELECT RENT_USER_NM,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100756' THEN B.EQUIP_TYPE ELSE NULL END) AS MEDC,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '101370' THEN B.EQUIP_TYPE ELSE NULL END) AS ECG_1,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100754' THEN B.EQUIP_TYPE ELSE NULL END) AS ECG_2,
				           COUNT(CASE WHEN B.EQUIP_TYPE = '100755' THEN B.EQUIP_TYPE ELSE NULL END) AS BLDPRS,
				           COUNT(*) AS ALE
				    FROM (   
				            SELECT  * 
							FROM (
									 SELECT * 
		                             FROM(   
		                                SELECT  ROW_NUMBER() OVER(PARTITION BY EQUIPMENT_SEQ ORDER BY RENT_DT DESC) AS RN, A.*, B.CD, B.CATGR, B.CD_ID
		                                FROM    TB_RENT_MNG A
		                                        LEFT OUTER JOIN TB_CODE_MASTER B 
		                                        ON A.AREA_ID = B.CD_ID 
		                            	) 
		                            WHERE RN=1
	                        )
							WHERE   1=1 
	                        <if test="AREA_ID != null">
							        AND CATGR = '100703'  
	                                AND (   CD = #{AREA_ID}
							                OR CD_ID LIKE REPLACE((SELECT CD_ID FROM TB_CODE_MASTER WHERE CATGR='100703' AND CD=#{AREA_ID}), '00000000', '')||'%'
	                                    )
	                        </if>
	                    ) A 
				         LEFT OUTER JOIN TB_EQUIPMENT_INFO B
				         ON A.EQUIPMENT_SEQ = B.EQUIPMENT_SEQ
				    GROUP BY USER_ID, RENT_USER_NM
				) A
			)
			WHERE 1=1 
   		    <if test="G_EquipmentVal neq 'ALL'"> 
				<if test="G_EquipmentVal eq 'MEDC'"> AND MEDC > 0 </if>
				<if test="G_EquipmentVal eq 'ECG_1'"> AND ECG_1 > 0 </if>
				<if test="G_EquipmentVal eq 'ECG_2'"> AND ECG_2 > 0 </if>
				<if test="G_EquipmentVal eq 'BLDPRS'"> AND BLDPRS > 0 </if>
			</if>
  </select>
</mapper>