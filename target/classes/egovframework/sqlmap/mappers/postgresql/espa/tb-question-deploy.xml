<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="egovframework.espa.service.impl.QuestionDeployMapper">

	<select id="readDeployList" parameterType="hashMap" resultType="hashMap">
		SELECT *
		FROM (
			SELECT (ROW_NUMBER() OVER()) AS RNUM, A.*
			FROM (
				SELECT
					A.deploy_seq,
					A.question_seq, 
					A.group_id,
					B.cd_nm as group_name,
					A.submit_from,
					A.submit_to,
					A.submit_count,
					A.title,
					C.title as question_title,
					C.lang_type as question_language
				FROM TB_QUESTION_DEPLOY A 
				INNER JOIN TB_CODE_MASTER B ON A.GROUP_ID = B.CD_ID
				INNER JOIN TB_QUESTION C ON A.QUESTION_SEQ = C.QUESTION_SEQ 
			) A
		) A
		WHERE 1 = 1
		<if test='PAGE != null'>
		<![CDATA[
			AND A.RNUM > (#{PAGE} - 1) * #{PAGESIZE}
			AND A.RNUM <= #{PAGE} * #{PAGESIZE}
    	]]>
		</if>
		ORDER BY submit_from, submit_to
	</select>
	
	<select id="readDeploy" parameterType="hashMap" resultType="hashMap">
		SELECT
			A.deploy_seq,
			A.question_seq, 
			A.group_id,
			B.cd_nm as group_name,
			A.submit_from,
			A.submit_to,
			A.submit_count,
			A.title,
			C.title as question_title,
			C.lang_type as question_language
		FROM TB_QUESTION_DEPLOY A 
		INNER JOIN TB_CODE_MASTER B ON A.GROUP_ID = B.CD_ID
		INNER JOIN TB_QUESTION C ON A.QUESTION_SEQ = C.QUESTION_SEQ 
		WHERE deploy_seq = CAST(#{deploy_seq} as integer) 
	</select>
	
	<select id="readDeployAllCount" parameterType="hashMap" resultType="integer">
		SELECT count(*)
		FROM TB_QUESTION_DEPLOY A 
		inner join tb_code_master B on A.group_id = B.cd_id
		inner join tb_question C on A.question_seq = C.question_seq 
	</select>
	
	<insert id="createDeploy">
		INSERT INTO TB_QUESTION_DEPLOY (
			deploy_seq,
			title,
			question_seq,
			group_id, 
			submit_from,
			submit_to,
			submit_count
		) VALUES (
			nextval('sq_tb_question_deploy'), 
			#{title}, 
			cast(#{question_seq} as integer), 
			#{group_id}, 
			to_timestamp(#{submit_from}, 'YYYY-MM-DD HH24:MI'),
			to_timestamp(#{submit_to}, 'YYYY-MM-DD HH24:MI'),
			cast(#{submit_count} as integer)
		)
	</insert>
	
	<update id="updateDeploy">
		UPDATE tb_question_deploy
		SET 
			question_seq = cast(#{question_seq} as integer),
			title = #{title},  
			group_id = #{group_id},  
			submit_from = to_timestamp(#{submit_from}, 'YYYY-MM-DD HH24:MI'),
			submit_to = to_timestamp(#{submit_to}, 'YYYY-MM-DD HH24:MI'),
			submit_count = cast(#{submit_count} as integer)
		WHERE deploy_seq = cast(#{deploy_seq} as integer)
	</update>
	
	<delete id="deleteDeploy">
		DELETE FROM tb_question_deploy 
		WHERE deploy_seq = CAST(#{deploy_seq} as integer) 
	</delete>
</mapper>
